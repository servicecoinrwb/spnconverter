<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Point Network Rewards Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .external-link::after {
        content: ' â†—';
        font-size: 0.8em;
        vertical-align: super;
    }
    #customer-list-body::-webkit-scrollbar, #transaction-log::-webkit-scrollbar {
        width: 6px;
    }
    #customer-list-body::-webkit-scrollbar-track, #transaction-log::-webkit-scrollbar-track {
        background: #374151; /* gray-700 */
    }
    #customer-list-body::-webkit-scrollbar-thumb, #transaction-log::-webkit-scrollbar-thumb {
        background: #6b7280; /* gray-500 */
        border-radius: 3px;
    }
  </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-10 pb-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Service Point Network</h1>
        <p class="text-lg text-gray-600 dark:text-gray-400">Rewards & Administration Portal</p>
      </div>
      <div id="wallet-status">
         <button onclick="connectWallet()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Connect Wallet</button>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <!-- Left Column: System Info -->
      <div class="lg:col-span-1 space-y-8">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">1. System Configuration</h2>
          <div class="space-y-4 text-sm">
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">SPN Token:</span><a id="spn-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">Staking Contract:</span><a id="staking-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">SRV Token:</span><a id="srv-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">SREV Token:</span><a id="srev-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">Converter Contract:</span><a id="converter-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">Yield Contract:</span><a id="yield-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">Reward Token:</span><a id="reward-address" href="#" target="_blank" class="font-mono text-blue-500 hover:underline external-link"></a></div>
             <hr class="border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">Yield Contract Balance:</span><span id="yield-balance" class="font-mono font-bold text-green-500">...</span></div>
            <div class="flex justify-between items-center"><span class="font-semibold text-gray-600 dark:text-gray-400">Total SPN Minted:</span><span id="spn-total-supply" class="font-mono font-bold text-green-500">...</span></div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">Transaction Log</h2>
           <ul id="transaction-log" class="space-y-2 h-96 overflow-y-auto text-sm">
                <li class="text-gray-500 dark:text-gray-400">No actions performed yet.</li>
            </ul>
        </div>
      </div>

      <!-- Right Column: Actions -->
      <div class="lg:col-span-2 space-y-8">
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">2. Add Customer to Dashboard</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div class="md:col-span-1">
              <label for="customerNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Customer Number *</label>
              <input type="text" id="customerNumber" placeholder="e.g. CUST-1001" class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
            </div>
            <div class="md:col-span-1">
              <label for="customerWallet" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Customer Wallet Address *</label>
              <input type="text" id="customerWallet" placeholder="0x..." class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3">
            </div>
             <button onclick="addCustomer()" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">Add Customer</button>
          </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">3. Admin: Issue Tokens</h2>
            <div class="space-y-4">
                 <div>
                    <h3 class="font-semibold text-lg mb-2">Mint SPN (Points)</h3>
                    <div class="flex items-center gap-3">
                        <input id="issueTarget" type="text" placeholder="Target Address" class="block w-full bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
                        <input id="issueAmount" type="number" placeholder="e.g. 500" class="block w-full bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
                        <button onclick="issueSPN()" class="bg-green-600 text-white font-bold py-3 px-5 rounded-lg whitespace-nowrap">Issue SPN</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">
              <h2 class="text-xl font-bold">4. Customer Userbase</h2>
              <button onclick="refreshAllBalances()" class="text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">Refresh All</button>
            </div>
            <div id="customer-list-container" class="h-64 overflow-y-auto pr-2">
                <table class="w-full text-sm text-left">
                    <thead class="sticky top-0 bg-gray-50 dark:bg-gray-700 text-xs text-gray-700 dark:text-gray-400 uppercase">
                        <tr>
                            <th scope="col" class="px-4 py-3">Customer</th>
                            <th scope="col" class="px-4 py-3 text-right">SPN</th>
                            <th scope="col" class="px-4 py-3 text-right">SRV</th>
                            <th scope="col" class="px-4 py-3 text-right">SREV</th>
                            <th scope="col" class="px-4 py-3 text-right">USDC</th>
                            <th scope="col" class="px-4 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customer-list-body">
                        <tr>
                            <td colspan="6" class="text-center py-10 text-gray-500 dark:text-gray-400">No customers added yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    let provider, signer;
    let customers = [];
    let contracts = {};

    const addresses = {
        spn: '0x29950e318e999f4907772e9eb0ce3606eb48f490',
        staking: '0x691ae29e96ecdc5ae9483a033b8b2e24c5ae9483',
        srv: '0x057ba66c2109fd4487f0d6696662335d5b7ba66c',
        srev: '0x2f745da2fa453ee76c75edb3a432268e5831c2f0',
        converter: '0x524997f5cf25537a275a1d19d4a2e9eb0ce3606e',
        yield: '0x7ff618efb0422687e5b2a0af3839290b0ef5b2a0',
        reward: '0xaf88d065e77c8cc2239327c5edb3a432268e5831'
    };

    const abis = {
        erc20: JSON.parse(`[{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"to","type":"address"},{"name":"value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"}]`),
        spn: JSON.parse(`[{"inputs":[{"internalType":"address","name":"admin","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"SPNMinted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MINTER_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"}]`),
        srv: JSON.parse(`[{"inputs":[{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"symbol","type":"string"},{"internalType":"string","name":"logo","type":"string"},{"internalType":"uint8","name":"decimals","type":"uint8"},{"internalType":"uint256","name":"initialSupply","type":"uint256"},{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"address","name":"treasury","type":"address"},{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"address","name":"tokenStore","type":"address"},{"components":[{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"transferFee","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"burn","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"reflection","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"buyback","type":"tuple"}],"internalType":"struct ITokenLauncherERC20.Fees","name":"fees","type":"tuple"},{"internalType":"address","name":"buybackHandler","type":"address"},{"internalType":"enum ITokenLauncherCommon.PaymentMethod","name":"paymentMethod","type":"uint8"}],"internalType":"struct ITokenLauncherERC20.CreateErc20Input","name":"_input","type":"tuple"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"router","type":"address"},{"indexed":true,"internalType":"address","name":"pairToken","type":"address"},{"indexed":false,"internalType":"uint256","name":"liquidityBasisPoints","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"priceImpactBasisPoints","type":"uint256"}],"name":"BuyBackDetailsUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"pool","type":"address"}],"name":"ExchangePoolAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"pool","type":"address"}],"name":"ExchangePoolRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"}],"name":"ExemptedAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"}],"name":"ExemptedRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"newTokenLauncher","type":"address"}],"name":"TokenLauncherUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"receiver","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":true,"internalType":"string","name":"taxType","type":"string"}],"name":"TransferTax","type":"event"},{"inputs":[],"name":"BURN_ADDRESS","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_MANAGER_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MULTIPLIER_BASIS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"pool","type":"address"}],"name":"addExchangePool","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"addExemptAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"buybackDetails","outputs":[{"internalType":"address","name":"pairToken","type":"address"},{"internalType":"address","name":"router","type":"address"},{"internalType":"uint256","name":"liquidityBasisPoints","type":"uint256"},{"internalType":"uint256","name":"priceImpactBasisPoints","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"buybackHandler","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"excludeAccount","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"fees","outputs":[{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"transferFee","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"burn","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"reflection","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"buyback","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"includeAccount","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"pool","type":"address"}],"name":"isExchangePool","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"isExcludedFromReflectionRewards","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"isExemptedFromTax","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isReflectionToken","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"logo","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tAmount","type":"uint256"}],"name":"reflect","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tAmount","type":"uint256"},{"internalType":"bool","name":"deductTransferFee","type":"bool"}],"name":"reflectionFromToken","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"pool","type":"address"}],"name":"removeExchangePool","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"removeExemptAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"components":[{"internalType":"address","name":"pairToken","type":"address"},{"internalType":"address","name":"router","type":"address"},{"internalType":"uint256","name":"liquidityBasisPoints","type":"uint256"},{"internalType":"uint256","name":"priceImpactBasisPoints","type":"uint256"}],"internalType":"struct ITokenLauncherLiquidityPoolFactory.BuyBackDetails","name":"_buybackDetails","type":"tuple"}],"name":"setBuybackDetails","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"rAmount","type":"uint256"}],"name":"tokenFromReflection","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"tokenLauncher","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalFees","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalReflection","outputs":[{"internalType":"uint256","name":"t","type":"uint256"},{"internalType":"uint256","name":"r","type":"uint256"},{"internalType":"uint256","name":"tFee","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"treasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"components":[{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"transferFee","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"burn","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"reflection","type":"tuple"},{"components":[{"internalType":"uint256","name":"percentage","type":"uint256"},{"internalType":"bool","name":"onlyOnSwaps","type":"bool"}],"internalType":"struct ITokenLauncherERC20.FeeDetails","name":"buyback","type":"tuple"}],"internalType":"struct ITokenLauncherERC20.Fees","name":"_fees","type":"tuple"}],"name":"updateFees","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newTokenLauncher","type":"address"}],"name":"updateTokenLauncher","outputs":[],"stateMutability":"nonpayable","type":"function"}]`),
        converter: JSON.parse('[{"inputs":[{"internalType":"address","name":"_for","type":"address"}],"name":"convert","outputs":[],"stateMutability":"nonpayable","type":"function"}]'),
        staking: JSON.parse('[{"inputs":[{"internalType":"address","name":"_for","type":"address"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"}]'),
        yield: JSON.parse(`[{"inputs":[{"internalType":"address","name":"_rewardToken","type":"address"},{"internalType":"address","name":"_srevToken","type":"address"},{"internalType":"address","name":"_daoOperator","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newAPR","type":"uint256"}],"name":"APRUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newInterval","type":"uint256"}],"name":"ClaimIntervalUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Claimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdrawal","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bool","name":"status","type":"bool"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RewardFunded","type":"event"},{"inputs":[],"name":"BPS_DIVISOR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"SECONDS_IN_YEAR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"users","type":"address[]"}],"name":"accrueAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"baseAPR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claim","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimInterval","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"daoOperator","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"fund","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastClaimTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastClaimed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"newAPR","type":"uint256"}],"name":"setBaseAPR","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newInterval","type":"uint256"}],"name":"setClaimInterval","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"_paused","type":"bool"}],"name":"setPaused","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"srevToken","outputs":[{"internalType":"contract ISREVToken","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"viewClaimCooldown","outputs":[{"internalType":"uint256","name":"secondsUntilClaimable","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"viewPending","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"viewRewardPoolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}]`)
    };

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        loadCustomersFromStorage();
        for (const [key, addr] of Object.entries(addresses)) {
            const el = document.getElementById(`${key}-address`);
            if (el) {
                el.textContent = `${addr.substring(0, 6)}...${addr.substring(addr.length - 6)}`;
                el.href = `https://arbiscan.io/address/${addr}`;
            }
        }
    });

    // --- Wallet Connection ---
    async function connectWallet() {
        if (typeof window.ethereum === 'undefined') {
            return showModal('Error', 'MetaMask is not installed. Please install it to use this dApp.');
        }
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            const address = await signer.getAddress();
            
            contracts.spn = new ethers.Contract(addresses.spn, abis.spn, signer);
            contracts.srv = new ethers.Contract(addresses.srv, abis.srv, signer);
            contracts.srev = new ethers.Contract(addresses.srev, abis.srv, signer); // Assuming SREV has a similar ABI to SRV
            contracts.reward = new ethers.Contract(addresses.reward, abis.erc20, signer);
            contracts.converter = new ethers.Contract(addresses.converter, abis.converter, signer);
            contracts.staking = new ethers.Contract(addresses.staking, abis.staking, signer);
            contracts.yield = new ethers.Contract(addresses.yield, abis.yield, signer);

            const walletStatusDiv = document.getElementById('wallet-status');
            walletStatusDiv.innerHTML = `<div class="text-right"><p class="font-semibold text-green-500">Connected</p><p class="text-xs font-mono">${address.substring(0, 6)}...${address.substring(address.length - 4)}</p></div>`;
            addLogEntry(`Wallet ${address.substring(0,6)}... connected.`);
        } catch (err) {
            console.error("Connection failed:", err);
            showModal('Connection Failed', err.message || 'Could not connect to wallet.');
        }
    }

    // --- Customer Management & Persistence ---
    function saveCustomersToStorage() {
        localStorage.setItem('spn_customer_userbase', JSON.stringify(customers.map(c => ({id: c.id, wallet: c.wallet}))));
    }

    function loadCustomersFromStorage() {
        const storedCustomers = localStorage.getItem('spn_customer_userbase');
        if (storedCustomers) {
            customers = JSON.parse(storedCustomers);
            renderCustomers(false); 
        }
    }

    async function fetchCustomerBalances(walletAddress) {
        if (!provider || Object.keys(contracts).length < 7) return { spn: 0, srv: 0, srev: 0, usdc: 0 };
        const balances = { spn: 'Err', srv: 'Err', srev: 'Err', usdc: 'Err' };
        
        try { balances.spn = parseFloat(ethers.formatUnits(await contracts.spn.balanceOf(walletAddress), 18)); } catch (e) { console.error(`SPN Balance Error:`, e); }
        try { balances.srv = parseFloat(ethers.formatUnits(await contracts.srv.balanceOf(walletAddress), 18)); } catch (e) { console.error(`SRV Balance Error:`, e); }
        try { balances.srev = parseFloat(ethers.formatUnits(await contracts.srev.balanceOf(walletAddress), 18)); } catch (e) { console.error(`SREV Balance Error:`, e); }
        try { balances.usdc = parseFloat(ethers.formatUnits(await contracts.reward.balanceOf(walletAddress), 6)); } catch (e) { console.error(`USDC Balance Error:`, e); }

        return balances;
    }

    async function addCustomer() {
        const customerNumberInput = document.getElementById('customerNumber');
        const customerWalletInput = document.getElementById('customerWallet');
        
        const customerNumber = customerNumberInput.value.trim();
        const customerWallet = customerWalletInput.value.trim();

        if (!customerNumber || !customerWallet) return showModal('Input Error', 'Please provide both a customer number and a wallet address.');
        if (!ethers.isAddress(customerWallet)) return showModal('Input Error', 'Please enter a valid wallet address.');
        if (!signer) return showModal('Error', 'Please connect your wallet first.');

        const balances = await fetchCustomerBalances(customerWallet);
        customers.push({ id: customerNumber, wallet: customerWallet, ...balances });
        
        saveCustomersToStorage();
        renderCustomers();
        addLogEntry(`Added customer ${customerNumber} (${customerWallet.substring(0,6)}...).`);
        
        customerNumberInput.value = '';
        customerWalletInput.value = '';
    }
    
    async function refreshAllBalances() {
        if (customers.length === 0) return showModal('Info', 'No customers to refresh.');
        if (!signer) return showModal('Error', 'Please connect your wallet first.');
        addLogEntry('Refreshing all customer balances...');
        for (const customer of customers) {
            const balances = await fetchCustomerBalances(customer.wallet);
            Object.assign(customer, balances);
        }
        renderCustomers();
        addLogEntry('All balances updated.');
    }
    
    function deleteCustomer(walletAddress) {
        customers = customers.filter(c => c.wallet.toLowerCase() !== walletAddress.toLowerCase());
        saveCustomersToStorage();
        renderCustomers(false);
        addLogEntry(`Removed customer ${walletAddress.substring(0,6)}...`);
    }

    function renderCustomers(fetchBalances = true) {
        const customerListBody = document.getElementById('customer-list-body');
        if (customers.length === 0) {
            customerListBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500 dark:text-gray-400">No customers added yet.</td></tr>`;
            return;
        }
        customerListBody.innerHTML = '';
        customers.forEach(customer => {
            const tr = document.createElement('tr');
            tr.className = 'bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 border-b dark:border-gray-700';
            tr.innerHTML = `
                <td class="px-4 py-3">
                    <p class="font-semibold text-sm text-gray-900 dark:text-gray-100">${customer.id}</p>
                    <a href="https://arbiscan.io/address/${customer.wallet}" target="_blank" class="text-xs font-mono text-blue-400 hover:underline">${customer.wallet}</a>
                </td>
                <td class="px-4 py-3 text-right font-mono">${typeof customer.spn === 'number' ? customer.spn.toLocaleString() : '...'}</td>
                <td class="px-4 py-3 text-right font-mono">${typeof customer.srv === 'number' ? customer.srv.toLocaleString() : '...'}</td>
                <td class="px-4 py-3 text-right font-mono">${typeof customer.srev === 'number' ? customer.srev.toLocaleString() : '...'}</td>
                <td class="px-4 py-3 text-right font-mono">$${typeof customer.usdc === 'number' ? customer.usdc.toFixed(2) : '...'}</td>
                <td class="px-4 py-3 text-right"><button onclick="deleteCustomer('${customer.wallet}')" class="text-red-500 hover:text-red-700 font-bold">X</button></td>
            `;
            customerListBody.appendChild(tr);
        });
    }

    // --- Action Functions ---
    async function issueSPN() {
        const target = document.getElementById('issueTarget').value;
        const amount = document.getElementById('issueAmount').value;
        if (!target || !amount) return showModal('Input Error', 'Please provide a target wallet and an amount to issue.');
        if (!ethers.isAddress(target)) return showModal('Input Error', 'Please enter a valid target wallet address.');
        await handleTransaction(contracts.spn, 'mint', [target, ethers.parseUnits(amount, 18)], `Mint ${amount} SPN`);
    }

    async function convertToSRV() {
        const target = document.getElementById('targetCustomer').value;
        if (!target) return showModal('Input Error', 'Please provide a target wallet address.');
        await handleTransaction(contracts.converter, 'convert', [target], 'Convert SPN to SRV');
    }

    async function stakeSRV() {
        const target = document.getElementById('targetCustomer').value;
        if (!target) return showModal('Input Error', 'Please provide a target wallet address.');
        await handleTransaction(contracts.staking, 'stake', [target], 'Stake SRV');
    }
    
    async function fundYieldContract() {
        const amount = document.getElementById('fundAmount').value;
        if (!amount) return showModal('Input Error', 'Please enter an amount to fund.');
        
        await handleApproval(contracts.reward, amount, addresses.yield, "Approve Reward Token");
        await handleTransaction(contracts.yield, 'fund', [ethers.parseUnits(amount, 6)], `Fund Yield Contract`);
    }
    
    async function handleApproval(contract, amount, spender, name) {
        if (!signer) return showModal('Error', 'Please connect your wallet first.');
        showModal('Processing', `Approving ${name}...`);
        try {
            const tx = await contract.approve(spender, ethers.parseUnits(amount, 18));
            addLogEntry(`Approval sent for "${name}": ${tx.hash.substring(0,10)}...`);
            await tx.wait();
            showModal('Success', `Approval for "${name}" confirmed!`);
            addLogEntry(`"${name}" approval confirmed.`);
        } catch(e) {
            console.error(`${name} approval failed:`, e);
            showModal('Error', `${name} approval failed: ${e.reason || e.message}`);
        }
    }

    async function handleTransaction(contract, method, args, name, refresh = true) {
        if (!signer) return showModal('Error', 'Please connect your wallet first.');
        showModal('Processing', `Sending "${name}" transaction...`);
        try {
            const tx = await contract[method](...args);
            addLogEntry(`Transaction sent for "${name}": ${tx.hash.substring(0,10)}...`);
            await tx.wait();
            showModal('Success', `"${name}" transaction confirmed!`);
            addLogEntry(`"${name}" transaction confirmed.`);
            if(refresh) refreshAllBalances();
            fetchSystemStats();
        } catch (e) {
            console.error(`${name} failed:`, e);
            showModal('Error', `${name} failed: ${e.reason || e.message}`);
        }
    }

    // --- Logging ---
    function addLogEntry(message) {
        const logList = document.getElementById('transaction-log');
        if (logList.children.length > 0 && logList.children[0].innerText.startsWith('No actions')) {
            logList.innerHTML = '';
        }
        
        const li = document.createElement('li');
        li.className = 'text-gray-600 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700 pb-1';
        
        const timestamp = new Date().toLocaleTimeString();
        li.innerHTML = `<span class="font-mono text-xs mr-2">[${timestamp}]</span> ${message}`;
        
        logList.prepend(li);
        if (logList.children.length > 50) {
            logList.removeChild(logList.lastChild);
        }
    }

    // --- UI Utility: Modal ---
    function showModal(title, message) {
        const existingModal = document.getElementById('alertModal');
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = 'alertModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center border-2 border-blue-500">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">${title}</h3>
                <p class="text-gray-600 dark:text-gray-300 mb-6 break-words">${message}</p>
                <button onclick="document.getElementById('alertModal').remove()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // --- Expose functions to global scope for HTML onclick handlers ---
    window.connectWallet = connectWallet;
    window.addCustomer = addCustomer;
    window.refreshAllBalances = refreshAllBalances;
    window.deleteCustomer = deleteCustomer;
    window.issueSPN = issueSPN;
    window.convertToSRV = convertToSRV;
    window.stakeSRV = stakeSRV;
    window.fundYieldContract = fundYieldContract;
    window.approveConversion = () => handleApproval(contracts.spn, document.getElementById('convertAmount').value, addresses.converter, 'Approve SPN for Conversion');
    window.convertSPN = () => handleTransaction(contracts.converter, 'burnAndConvert', [ethers.parseUnits(document.getElementById('convertAmount').value, 18)], 'Convert SPN to SRV', false);

  </script>
</body>
</html>
